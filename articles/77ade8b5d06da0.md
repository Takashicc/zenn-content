---
title: "GitHub Actionsã§ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["github", "githubactions"]
published: true
publication_name: ambr_inc
---

:::message
ã“ã®è¨˜äº‹ã¯[ambr, Inc. Advent Calendar 2024](https://adventar.org/calendars/10507)ã®6æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
:::

ã“ã‚“ã«ã¡ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®Takashiccã§ã™ã€‚
ä»Šå›ã¯ã‹ãªã‚Šé™å®šçš„ãªä½¿ã„æ–¹ã¨ãªã‚Šã¾ã™ãŒã€GitHub Actionsã§ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨

GitHub Actionsã‚’åˆ©ç”¨ã—ã¦PRã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆã—ã¦ã„ã‚‹éš›ã€æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

- PRã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—ã™ã‚‹ã€‚
- å–å¾—ã—ãŸãƒ–ãƒ©ãƒ³ãƒåã‚’ä½¿ã£ã¦ã€åˆ¥ã®ãƒªãƒã‚¸ãƒˆãƒªã®åŒåãƒ–ãƒ©ãƒ³ãƒã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹ã€‚
    - ã‚‚ã—ãã®ãƒ–ãƒ©ãƒ³ãƒåãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€ä½•ã‚‚ã—ãªã„ã€‚

å½“åˆã¯[actions/checkout](https://github.com/actions/checkout)ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¦å®Ÿç¾ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€1ç‚¹å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

## ãƒ–ãƒ©ãƒ³ãƒãŒãªã„å ´åˆã€ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’ç¹°ã‚Šè¿”ã™

[actions/checkout](https://github.com/actions/checkout)ã«ã¯ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ãŒã‚ã‚‹ã‚ˆã†ã§ã€æŒ‡å®šã—ãŸãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ•°ç§’å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã™ã‚‹ã¨ã„ã£ãŸå‹•ããŒã‚ã‚Šã¾ã—ãŸã€‚

ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ãŒã‚ã‚‹ã¨ãã®åˆ†ç„¡é§„ã«å¾…æ©Ÿã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€æŒ‡å®šã—ãŸãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã™ãã«ã‚¨ãƒ©ãƒ¼ã¨åˆ¤å®šã—ã¦æ¬²ã—ã„ã§ã™ã€‚
ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«[timeout-minutesã‚’ã‚¹ãƒ†ãƒƒãƒ—ã«è¨­å®šã™ã‚‹](https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions#jobsjob_idstepstimeout-minutes)ã¨ã„ã£ãŸã‚„ã‚Šæ–¹ã‚‚ã‚ã‚Šã¾ã™ãŒã€`timeout-minutes`ã«ã¯æœ€ä½1åˆ†ã¾ã§ã—ã‹æŒ‡å®šã§ããªã„ãŸã‚ã€ç„¡é§„ã«1åˆ†èª²é‡‘ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

## ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹

`git`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦Cloneã—ã¾ã™ã€‚
ãƒ­ãƒ¼ã‚«ãƒ«ã ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã§ã§ãã¾ã™ãŒã€

```bash
git clone --branch "$BRANCH_NAME" git@github.com:org/repo.git ./out
```

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã§å‹•ä½œã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã§Cloneã—ã¾ã™ã€‚

```bash
git clone --branch "$BRANCH_NAME" "https://x-access-token:${TOKEN}@github.com/org/another-repo.git" ./another-repo
```

`TOKEN`ã¯`${{ github.token }}`ãŒä½¿ãˆã¾ã™ãŒã€ä»Šå›ã¯åŒã˜Organizationã«ã‚ã‚‹åˆ¥ãƒªãƒã‚¸ãƒˆãƒªã‚’å‚ç…§ã™ã‚‹ãŸã‚ã€GitHub AppsãŒç™ºè¡Œã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã„ã¾ã™ã€‚
GitHub Appsã«ã¤ã„ã¦ã®è©³ç´°ã¯ã“ã“ã§ã¯çœãã¾ã™ãŒã€äº‹å‰ã«GitHub Appsã‚’ä½œæˆã—ã€ã‚¯ãƒ­ãƒ¼ãƒ³å¯¾è±¡ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã¾ã™ã€‚

å…¨ä½“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚

:::details manual_checkout.yml

```yml
on:
  pull_request:
    types:
      - opened
      - synchronize

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  checkout-manually:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: org
          repositories: another-repo

      - name: Get branch name
        id: get-branch-name
        run: echo "branch=${{ github.event.pull_request.head.ref }}" >> "$GITHUB_OUTPUT"

      - name: Checkout another-repo with same branch name
        id: checkout-another-repo
        continue-on-error: true # ã‚¨ãƒ©ãƒ¼ãŒèµ·ã“ã£ãŸã¨ã—ã¦ã‚‚æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¾ã›ã‚‹
        run: |
          git clone --branch "$BRANCH_NAME" "https://x-access-token:${TOKEN}@github.com/org/another-repo.git" ./another-repo
        env: # https://docs.github.com/en/actions/security-for-github-actions/security-guides/security-hardening-for-github-actions?learn=getting_started&learnProduct=actions#using-an-intermediate-environment-variable
          BRANCH_NAME: "${{ steps.get-branch-name.outputs.branch }}"
          TOKEN: ${{ steps.app-token.outputs.token }}

      # another-repoã®ã‚¯ãƒ­ãƒ¼ãƒ³ã«æˆåŠŸã—ãŸå ´åˆ
      - name: Do something when another-repo clone succeeds
        if: ${{ steps.checkout-another-repo.outcome == 'success' }}
        run: |
          # do something
```

:::
