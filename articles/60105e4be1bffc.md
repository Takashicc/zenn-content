---
title: "ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã—ã¦ã„ã‚‹CLIã®ã‚»ãƒ«ãƒ•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ¤–"
type: "tech"
topics: ["github","go"]
published: true
---

## ã¯ã˜ã‚ã«

GitHubã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§CLIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã—ã¦ãŠã‚Šã€ä»Šã¾ã§ã¯Releasesãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚
ã—ã‹ã—ãªãŒã‚‰ã€æ›´æ–°ãŒã‚ã‚‹ãŸã³ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãƒã‚¤ãƒŠãƒªã‚’ç½®ãæ›ãˆã‚‹ã®ã¯é »åº¦ãŒå°‘ãªã„ã¨ã¯ã„ãˆã€ã¾ã‚æ‰‹é–“ã§ã™ã€‚
ä»Šå›ã¯ã€CLIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ©Ÿèƒ½ã¨ã—ã¦ã‚»ãƒ«ãƒ•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å®Ÿè£…ã§ããŸã®ã§ã€æ‰‹é †ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

## æ‰‹é †

:::message
äº‹å‰ã«[gh](https://cli.github.com/)ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€[ãƒ­ã‚°ã‚¤ãƒ³](https://cli.github.com/manual/gh_auth_login)ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

:::

### Releaseä¸€è¦§ã‹ã‚‰æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®åå‰ã‚’å–å¾—

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€ghã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã„ã¾ã™ã€‚
ãŸã ã—ã€ç›´æ¥ghã‚³ãƒãƒ³ãƒ‰ã‚’æ‰±ã†ã‚ã‘ã§ã¯ãªãã€å…¬å¼ãŒ[ãƒ©ã‚¤ãƒ–ãƒ©ãƒª](https://github.com/cli/go-gh)ã‚’æä¾›ã—ã¦ã„ã‚‹ã®ã§ã“ã¡ã‚‰ã‚’ä½¿ã„ã¾ã™ã€‚

```go
import (
	"encoding/json"
	"fmt"

	"github.com/cli/go-gh/v2"
	"github.com/cockroachdb/errors"
)

const REPO = "org/repo" // ãƒªãƒã‚¸ãƒˆãƒªå

type ReleaseInfo struct {
	Name     string `json:"name"`
	IsLatest bool   `json:"isLatest"`
}

func GetLatestReleaseName() (string, error) {
	releaseListRes, _, err := gh.Exec("release", "list", "-R", REPO, "--json", "isLatest,name")
	if err != nil {
		return "", errors.Wrap(err, "failed to get latest release. have you set up gh?")
	}

	var releases []ReleaseInfo
	if err := json.Unmarshal(releaseListRes.Bytes(), &releases); err != nil {
		return "", errors.Wrap(err, "failed to unmarshal release list")
	}

	var latestRelease *ReleaseInfo
	for i := range releases {
		release := releases[i]
		if release.IsLatest {
			latestRelease = &release
			break
		}
	}
	if latestRelease == nil {
		return "", errors.New("failed to find latest release")
	}

	return latestRelease.Name, nil
}
```

### ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¯”è¼ƒ

ã“ã“ã§ã¯[semver](https://pkg.go.dev/golang.org/x/mod/semver)ã‚’ä½¿ã£ã¦æ¯”è¼ƒã—ã¾ã™ã€‚

```go
import "golang.org/x/mod/semver"

func shouldUpdate(currentVersion, latestVersion string) bool {
	return semver.Compare(currentVersion, latestVersion) < 0
}
```

### æˆæœç‰©ã‚’å–å¾—

ã‚¿ã‚°åã¨æˆæœç‰©åã‚’æŒ‡å®šã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

```go
import (
	"github.com/cli/go-gh/v2"
	"github.com/cockroachdb/errors"
)

const ASSET_NAME = "asset" // æˆæœç‰©å

func fetchRelease(tag string) ([]byte, error) {
	res, _, err := gh.Exec("release", "download", "-O", "-", "-R", REPO, "-p", ASSET_NAME, tag)
	if err != nil {
		return nil, errors.Wrap(err, "failed to download release")
	}

	return res.Bytes(), nil
}
```

### ã‚»ãƒ«ãƒ•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

[go-update](https://github.com/inconshreveable/go-update)ã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒ«ãƒ•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’è¡Œã„ã¾ã™ã€‚

```go
import (
	"bytes"

	"github.com/cockroachdb/errors"
	"github.com/inconshreveable/go-update"
)

func selfUpdate(b []byte) error {
	if err := update.Apply(bytes.NewReader(b), update.Options{}); err != nil {
		return errors.Wrap(err, "failed to apply update")
	}
	return nil
}
```

## å‚è€ƒ

<https://cli.github.com/manual/gh>
<https://github.com/cli/go-gh>
<https://github.com/inconshreveable/go-update>
<https://zenn.dev/kamina_zzz/articles/e9d68da8a88cf2>
