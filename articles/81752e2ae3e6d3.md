---
title: "ç„¡é§„ãªãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æŠ‘ãˆã‚‹"
emoji: "ğŸ’¨"
type: "tech"
topics: ["github", "githubactions", "cicd"]
published: false
publication_name: ambr_inc
---

## ã¯ã˜ã‚ã«

é–‹ç™ºç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’GitHub Actionsã§å¹³æ—¥ã®æ¯æœ6æ™‚ã«è¡Œã†ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ã‚³ãƒŸãƒƒãƒˆãŒãªã„å ´åˆã¯å·®åˆ†ãŒãªã„ã®ã«ãƒ‡ãƒ—ãƒ­ã‚¤ãŒèµ°ã£ã¦ã—ã¾ã„ã€GitHub Actionsã®ç¨¼åƒæ™‚é–“ãŒã‚ãšã‹ã¨ã¯ã„ãˆãƒ©ãƒ³ãƒŠãƒ¼æ™‚é–“ã‚’æµªè²»ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
ã“ã‚Œã‚’æŠ‘ãˆã‚‹ãŸã‚ã«è¿½åŠ ã‚¸ãƒ§ãƒ–ã§é‡è¤‡ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é˜²ãæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## äº‹å‰æº–å‚™

### Repository Variables

Repository Variablesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚³ãƒŸãƒƒãƒˆSHAã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°ã‚’ç”¨æ„ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®URLã®`org/repo`ã‚’è‡ªåˆ†ã®ãƒªãƒã‚¸ãƒˆãƒªã«æ›¸ãæ›ãˆã¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€
<https://github.com/org/repo/settings/variables/actions>

ä¸‹è¨˜ã®ã‚ˆã†ãªè¨­å®šç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚
![](/images/81752e2ae3e6d3/repository-variables-settings.png)

å³ä¸‹ã®ã€ŒNew repository variableã€ã‹ã‚‰æ–°ã—ãRepository Variableã‚’ä½œã‚Šã¾ã™ã€‚
ã“ã“ã§ã¯[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“](#ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“)ã«ã‚ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«è¨˜è¼‰ãŒã‚ã‚‹`API_LATEST_DEPLOYED_COMMIT_ID`ã¨ã„ã†åå‰ã§ç™»éŒ²ã—ã¾ã™ã€‚å€¤ã¯é©å½“ã«ç™»éŒ²ã—ã¾ã™ã€‚

![](/images/81752e2ae3e6d3/new-repository-variable.png)

### GitHub Appsã®ä½œæˆ

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã§Repository Variablesã‚’èª­ã¿æ›¸ãã™ã‚‹ãŸã‚ã€æ¨©é™ã‚’ä»˜ä¸ã—ãŸGitHub Appsã‚’ä½œæˆã—ã¾ã™ã€‚(GitHub Appsã‚’ä½¿ã‚ãšã«ã§ãã‚‹è¿‚å›ç­–ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“...)

ä»Šå›ã¯ãƒªãƒã‚¸ãƒˆãƒªãŒæ‰€å±ã—ã¦ã„ã‚‹çµ„ç¹”ã®è¨­å®šç”»é¢ã‹ã‚‰GitHub Appsã‚’ä½œæˆã—ã¾ã™ã€‚
Repository permissionsã«ã‚ã‚‹Variablesã®Accessã‚’Read and writeã«è¨­å®šã—ã¦ãã ã•ã„ã€‚

![](/images/81752e2ae3e6d3/github-app-permission.png)

GitHub Appsã‚’ä½œæˆå¾Œã€å¯¾è±¡ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

![](/images/81752e2ae3e6d3/github-app-install.png =300x)

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€å¯¾è±¡ã®ãƒªãƒã‚¸ãƒˆãƒªã®è¨­å®šç”»é¢ã‹ã‚‰Repository Secretsã«ä½œæˆã—ãŸGitHub Appsã®`APP_ID`ã€`PRIVATE_KEY`ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“

ã¾ãšã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã§ã™ã€‚ãã‚Œãã‚Œã®ã‚¸ãƒ§ãƒ–ãŒã—ã¦ã„ã‚‹ã“ã¨ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚
è»½ãèª¬æ˜ã™ã‚‹ã¨ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚³ãƒŸãƒƒãƒˆSHAã‚’Repository Variablesã«ä¿å­˜ã—ã¦ãŠã„ã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‚³ãƒŸãƒƒãƒˆSHAã¨æ¯”è¼ƒã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

å®Ÿéš›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å‹•ãã¾ã™ã€‚

- ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ãªã„ã‚³ãƒŸãƒƒãƒˆã®å ´åˆ
    - ![](/images/81752e2ae3e6d3/new-deployment.png)
- ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒŸãƒƒãƒˆã®å ´åˆ
    - ![](/images/81752e2ae3e6d3/same-deployment.png)

:::message
ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å¹³æ—¥æœ6æ™‚ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å®Ÿè¡Œã®2ã¤ã®æ–¹æ³•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å‹•ã‹ã™ã“ã¨ãŒã§ãã€**ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã‹ã¤ã‚³ãƒŸãƒƒãƒˆSHAã«å·®åˆ†ãŒãªã„ã¨ãã®ã¿**ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å®Ÿè¡Œã®å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆSHAã«å·®åˆ†ãŒã‚ã‚ã†ã¨ãªã‹ã‚ã†ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

ã¾ãŸã€ç’°å¢ƒã”ã¨(dev, stgç’°å¢ƒãªã©)ã§ã‚³ãƒŸãƒƒãƒˆSHAã‚’åŒºåˆ¥ã—ã¦ã„ãªã„ã®ã§ã€åŒºåˆ¥ã—ãŸã„å ´åˆã¯ãã®ã¶ã‚“Repository Variable(ã¾ãŸã¯Environment Variable)ã«å¤‰æ•°ã‚’ç”¨æ„ã™ã‚‹ã®ã¨ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å†…å®¹ã‚’ä¸€éƒ¨å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
:::

```yml
name: Deploy

on:
  schedule:
    - cron: "0 21 * * 0-4" # å¹³æ—¥æœ6æ™‚(æ—¥æœ¬æ™‚é–“)
  workflow_dispatch:
    inputs:
      environment:
        type: environment
        required: true

defaults:
  run:
    shell: bash

jobs:
  deployment-check-on-schedule:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      result: ${{ steps.compare.outputs.result }}
    steps:
      - id: repository
        run: echo "name=${GITHUB_REPOSITORY#${GITHUB_REPOSITORY_OWNER}/}" >> $GITHUB_OUTPUT

      - uses: actions/create-github-app-token@v1
        id: create_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ steps.repository.outputs.name }}

      - name: Compare the current commit id and the latest deployed commit id
        id: compare
        run: |
          current_commit_id=${{ github.sha }}
          latest_deployed_commit_id=$(gh variable get API_LATEST_DEPLOYED_COMMIT_ID -R ${{ github.repository }})
          echo "current_commit_id: ${current_commit_id}"
          echo "latest_deployed_commit_id: ${latest_deployed_commit_id}"
          echo "result=$([ $current_commit_id = $latest_deployed_commit_id ]; echo $?)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.create_token.outputs.token }}

  deploy:
    name: deploy
    needs: deployment-check-on-schedule
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && needs.deployment-check-on-schedule.outputs.result == '1') }}
    uses: ./.github/workflows/internal_deploy.yaml
    with:
      environment: ${{ github.event.inputs.environment || 'dev' }}
      workingDirectory: ./cdk/api/
    secrets: inherit

  set-latest-deployed-commit-id:
    name: Set the latest deployed commit id
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 5
    steps:
      - id: repository
        run: echo "name=${GITHUB_REPOSITORY#${GITHUB_REPOSITORY_OWNER}/}" >> $GITHUB_OUTPUT

      - uses: actions/create-github-app-token@v1
        id: create_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ steps.repository.outputs.name }}

      - name: Set the latest deployed commit id
        run: gh variable set API_LATEST_DEPLOYED_COMMIT_ID -b ${{ github.sha }} -R ${{ github.repository }}
        env:
          GH_TOKEN: ${{ steps.create_token.outputs.token }}
```

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®èª¬æ˜

### ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã‚¸ãƒ§ãƒ–

ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã®ã‚³ãƒŸãƒƒãƒˆSHAã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‚³ãƒŸãƒƒãƒˆSHAã‚’æ¯”è¼ƒã—ã¾ã™ã€‚

```yml
  deployment-check-on-schedule:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # æ¬¡ã®ã‚¸ãƒ§ãƒ–(deploy)ã«æ¸¡ã™ãŸã‚ã«æ¯”è¼ƒçµæœã‚’æ ¼ç´
    outputs:
      result: ${{ steps.compare.outputs.result }}
    steps:
      # github contextã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªã®åå‰ã ã‘ã‚’ç›´æ¥å–å¾—ã§ããªã„ãŸã‚ã€bashã®å¤‰æ•°å±•é–‹ã‚’ã¤ã‹ã£ã¦ãƒªãƒã‚¸ãƒˆãƒªåã ã‘ã‚’å–å¾—ã™ã‚‹
      # org/repo ã‹ã‚‰ repo ã ã‘å–å¾—
      - id: repository
        run: echo "name=${GITHUB_REPOSITORY#${GITHUB_REPOSITORY_OWNER}/}" >> $GITHUB_OUTPUT

      # Repository Variableã‚’èª­ã‚€ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’GitHub Appsã‹ã‚‰ç™ºè¡Œ
      - uses: actions/create-github-app-token@v1
        id: create_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ steps.repository.outputs.name }}

      # ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã®ã‚³ãƒŸãƒƒãƒˆSHAã¨ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‚³ãƒŸãƒƒãƒˆSHAã®æ¯”è¼ƒ
      # æ¯”è¼ƒçµæœã‚’GITHUB_OUTPUTã«å‡ºåŠ›
      - name: Compare the current commit id and the latest deployed commit id
        id: compare
        run: |
          current_commit_id=${{ github.sha }}
          latest_deployed_commit_id=$(gh variable get API_LATEST_DEPLOYED_COMMIT_ID -R ${{ github.repository }})
          echo "current_commit_id: ${current_commit_id}"
          echo "latest_deployed_commit_id: ${latest_deployed_commit_id}"
          echo "result=$([ $current_commit_id = $latest_deployed_commit_id ]; echo $?)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.create_token.outputs.token }}
```

### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–

å®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†ã‚¸ãƒ§ãƒ–ã§ã™ã€‚
`needs`ã§å‰æã¨ãªã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã‚¸ãƒ§ãƒ–ã‚’æŒ‡å®šã—ã€`if`æ¡ä»¶ã§ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã€ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‹ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚

```yml
  deploy:
    name: deploy
    needs: deployment-check-on-schedule
    # ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å®Ÿè¡Œ
    # ã¾ãŸã¯
    # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ ã‹ã¤ ã‚³ãƒŸãƒƒãƒˆSHAã®æ¯”è¼ƒçµæœãŒä¸€è‡´ã—ãªã‹ã£ãŸã¨ã
    # ä¸Šè¨˜ã®æ¡ä»¶ã‚’æº€ãŸã—ãŸã¨ãã«ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã—ã¾ã™
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && needs.deployment-check-on-schedule.outputs.result == '1') }}
    uses: ./.github/workflows/internal_deploy.yaml
    with:
      environment: ${{ github.event.inputs.environment || 'dev' }}
      workingDirectory: ./cdk/api/
    secrets: inherit
```

### ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã‚¸ãƒ§ãƒ–

ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸå¾Œã€ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚³ãƒŸãƒƒãƒˆSHAã‚’Repository Variablesã«ä¿å­˜ã™ã‚‹ã‚¸ãƒ§ãƒ–ã§ã™ã€‚
`needs`ã§å‰æã¨ãªã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ã‚’æŒ‡å®šã—ã€`gh`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦`API_LATEST_DEPLOYED_COMMIT_ID`å¤‰æ•°ã‚’æ›´æ–°ã—ã¾ã™ã€‚

```yml
  set-latest-deployed-commit-id:
    name: Set the latest deployed commit id
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 5
    steps:
      - id: repository
        run: echo "name=${GITHUB_REPOSITORY#${GITHUB_REPOSITORY_OWNER}/}" >> $GITHUB_OUTPUT

      - uses: actions/create-github-app-token@v1
        id: create_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ steps.repository.outputs.name }}

      - name: Set the latest deployed commit id
        run: gh variable set API_LATEST_DEPLOYED_COMMIT_ID -b ${{ github.sha }} -R ${{ github.repository }}
        env:
          GH_TOKEN: ${{ steps.create_token.outputs.token }}
```
