---
title: "Environmentsã¨Reusable workflowsã‚’ä½¿ã£ãŸå‡¦ç†ã®å…±é€šåŒ–"
emoji: "ğŸ“š"
type: "tech"
topics: ["githubactions","github"]
published: true
---

<!-- textlint-disable ja-technical-writing/ja-no-mixed-period -->
:::message
ã“ã®è¨˜äº‹ã¯[GitHub Actions Advent Calendar 2023](https://qiita.com/advent-calendar/2023/github-actions)ã®16æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
:::
<!-- textlint-enable ja-technical-writing/ja-no-mixed-period -->

# ã¯ã˜ã‚ã«

ä»Šã¾ã§ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã”ã¨ã«workflowãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦ã„ã¾ã—ãŸã€‚

```txt
.github
â””â”€â”€ workflows
    â”œâ”€â”€ deploy_dev.yml
    â””â”€â”€ deploy_prod.yml
```

ä¸Šè¨˜ã‚’Reusable workflowã‚’ä½¿ã†ã“ã¨ã§å…±é€šåŒ–ã§ããŸã®ã§ã¾ã¨ã‚ã¾ã™ã€‚

```txt
.github
â””â”€â”€ workflows
    â”œâ”€â”€ deploy.yml
    â””â”€â”€ internal_deploy.yml
```

# å•é¡Œ

ç’°å¢ƒã”ã¨ã«workflowãƒ•ã‚¡ã‚¤ãƒ«ãŒåˆ†ã‹ã‚Œã¦ãŠã‚Šã€å‡¦ç†å†…å®¹ã¯ã¾ã£ãŸãåŒã˜ã§ã—ãŸã€‚
å‡¦ç†å†…å®¹ã®å¤‰æ›´ã‚„æ–°ãŸãªç’°å¢ƒã®è¿½åŠ ãŒã‚ã‚‹ã¨ã€å„workflowãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€æ‰‹é–“ã«ãªã‚Šãã†ã§ã™ã€‚

# Reusable workflowã‚’ä½¿ã†

## Reusable workflowã®ä½œæˆ

å…±é€šã—ãŸå‡¦ç†å†…å®¹ã‚’Reusable workflowã«æ›¸ãã¾ã™ã€‚

- `on.workflow_call`ã§åˆ¥ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
- `on.workflow_call.inputs`ã§å¼•æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚
- `on.workflow_call.secrets`ã§secretã‚’è¨­å®šã—ã¾ã™ã€‚
- `deploy`ã‚¸ãƒ§ãƒ–ã®`environment`ã«å¼•æ•°ã®`environment`ã‚’è¨­å®šã—ã¾ã™ã€‚

:::message
è¨­å®šã—ãŸenvironmentã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ã†éš›ã€`on.workflow_call.secrets`ã«åŒåã®åç§°ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
<https://github.com/orgs/community/discussions/25238#discussioncomment-3247035>
:::

```yml:.github/workflows/internal_deploy.yml
name: Deploy

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 120
    environment: ${{ inputs.environment }}
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup node.js
        uses: actions/setup-node@v4

      - name: install cli
        run: npm i -g aws-cdk

      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Deploy
        run: cdk deploy --context env=${{ inputs.environment }} --require-approval never
```

## Reusable workflowã®å‘¼ã³å‡ºã—

ç’°å¢ƒã”ã¨ã«Reusable workflowã‚’å‘¼ã³å‡ºã™workflowã‚’ä½œæˆã—ã¾ã™ã€‚

- `dev_v`ã€`prod_v`ã‹ã‚‰å§‹ã¾ã‚‹ã‚¿ã‚°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã¨ãã«èµ·å‹•ã™ã‚‹workflowã§ã™ã€‚

- `deploy-to-dev`ã€`deploy-to-prod`ã‚¸ãƒ§ãƒ–ã‚’ç”¨æ„ã—ã¾ã™ã€‚
    - ã‚¿ã‚°åã«ã‚ˆã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚
    - `uses`ã«ä½œæˆã—ãŸReusable workflowã‚’æŒ‡å®šã—ã¾ã™ã€‚
    - `with`ã«å¼•æ•°ã‚’æ¸¡ã—ã¾ã™ã€‚
    - `secrets`ã«`inherit`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€Reusable workflowå†…ã§åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ(organizationã€repositoryã€environmentãƒ¬ãƒ™ãƒ«)ã‚’è‡ªå‹•çš„ã«å¼•ãç¶™ãã“ã¨ãŒã§ãã¾ã™ã€‚
        - <https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idsecretsinherit>

```yml:.github/workflows/deploy.yml
name: Deploy

on:
  push:
    tags:
      - "dev_v*"
      - "prod_v*"

jobs:
  integration:
    name: Integration
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      tag_name: ${{ steps.get_tag_name.outputs.TAG_NAME }}
    steps:
      - name: Get tag name
        id: get_tag_name
        run: |
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

  deploy-to-dev:
    name: Deploy to Development Environment
    needs: integration
    if: ${{ startsWith(needs.integration.outputs.tag_name, 'dev_v') }}
    uses: ./.github/workflows/internal_deploy.yml
    with:
      environment: dev
    secrets: inherit

  deploy-to-prod:
    name: Deploy to Production Environment
    needs: integration
    if: ${{ startsWith(needs.integration.outputs.tag_name, 'prod_v') }}
    uses: ./.github/workflows/internal_deploy.yml
    with:
      environment: prod
    secrets: inherit
```

# å‚è€ƒ

<https://docs.github.com/en/actions/using-workflows/reusing-workflows>

<https://docs.github.com/en/enterprise-cloud@latest/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_call>

<https://github.com/orgs/community/discussions/25238#discussioncomment-4367677>
