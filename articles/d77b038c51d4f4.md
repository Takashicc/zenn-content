---
title: "Sign in with Appleã¨Cognitoã®é€£æº"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [go, cognito, aws, contest2024]
published: false
publication_name: ambr_inc
---

:::message
ã“ã®è¨˜äº‹ã¯[ambr, Inc. Advent Calendar 2024](https://adventar.org/calendars/10507)ã®24æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
:::

ã“ã‚“ã«ã¡ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®Takashiccã§ã™ã€‚
ä»Šå›ã¯[gogh](https://gogh.gg)ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§å°å…¥ã—ãŸã€Sign in with Appleã®å®Ÿè£…ã®ç´¹ä»‹ã‚’ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
ãªãŠã€ä»Šå¾Œã¯Sign in with Appleã‚’SIWAã¨çœç•¥ã—ã¾ã™ã€‚

# ãªãœSIWAã‚’å°å…¥ã—ãŸã®ã‹

[gogh](https://gogh.gg)ã§ã¯ã€å¾“æ¥ã‚ˆã‚Šãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„é›»è©±ç•ªå·ã§ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãã¾ã—ãŸã€‚
ã—ã‹ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ãªèª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚

- èªè¨¼ãƒ¡ãƒ¼ãƒ«ã®é…å»¶
    - Gmailã§ã®ç™»éŒ²ãŒ1æ—¥ã«é›†ä¸­ã™ã‚‹ã¨èªè¨¼ãƒ¡ãƒ¼ãƒ«ã®é…ä¿¡ã«é…å»¶ãŒç™ºç”Ÿ(SPFã‚„DMARCãªã©ã¯è¨­å®šã—ã¦ã„ã¾ã™)
    - Twitterãªã©ã§ãƒã‚ºã‚‹ã¨èªè¨¼ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„ã“ã¨ãŒåŸå› ã§ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã§ããªã„å•ã„åˆã‚ã›ãŒç¶šå‡ºã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“
    - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„é›»è©±ç•ªå·ã§ã®ç™»éŒ²ã¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„èªè¨¼ãƒ¡ãƒ¼ãƒ«ãªã©è¤‡æ•°ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒåŸå› ã§é›¢è„±ã®åŸå› ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚
    - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šãŒå½“æ™‚ãªã‹ã£ãŸãŸã‚ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚‚ã†ä¸€åº¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

ã“ã‚Œã‚‰ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€Touch ID/Face IDã«ã‚ˆã‚‹ç”Ÿä½“èªè¨¼ã§ã‚¹ãƒ ãƒ¼ã‚ºãªãƒ­ã‚°ã‚¤ãƒ³ãŒå¯èƒ½ãªSIWAã‚’å°å…¥ã—ã¾ã—ãŸã€‚

# Cognitoã®SIWAå¯¾å¿œçŠ¶æ³ã«ã¤ã„ã¦

Cognitoã¯SIWAã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€ãƒ›ã‚¹ãƒ†ãƒƒãƒ‰UIã®ã¿ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚Šã€iOSãƒã‚¤ãƒ†ã‚£ãƒ–ã§ã®Touch ID(æŒ‡ç´‹èªè¨¼)ã‚„Face ID(é¡”èªè¨¼)ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚

https://github.com/aws-amplify/aws-sdk-ios/issues/2633

ä»Šå›ã¯ã€Touch IDã‚„Face IDã‚’ä½¿ã£ãŸå††æ»‘ãªãƒ­ã‚°ã‚¤ãƒ³ä½“é¨“ã‚’æä¾›ã—ãŸã‹ã£ãŸãŸã‚ã€Cognitoã®ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã‚’ä½¿ã†ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚

https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-challenge.html

# å…¨ä½“ã®ãƒ•ãƒ­ãƒ¼

ç°¡å˜ã«ã§ã™ãŒã€å…¨ä½“ã®ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚
Serverã¨Cognitoé–“ã®ç–é€šã«é–¢ã—ã¦ã‚‚ç°¡ç•¥ã—ã¦ã„ã¾ã™ã€‚(è©³ç´°ãƒ•ãƒ­ãƒ¼ã¯[å¾Œè¿°](#cognitoã¸ã®ç™»éŒ²ã€œã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã¾ã§)ã—ã¾ã™)

```mermaid
sequenceDiagram
	autonumber
    participant User
    participant Client
    participant Apple
    participant Server
    participant Cognito

    User->>Client: Sign in with Appleãƒœã‚¿ãƒ³æŠ¼ä¸‹
    Client->>Server: nonceè¦æ±‚
    Server-->>Client: nonceè¿”å´
    Client->>Client: Appleã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
    User->>Client: Touch ID/Face IDã§èªè¨¼
    Client->>Apple: Apple IDèªè¨¼
    Apple-->>Client: Authorization Codeè¿”å´

    Client->>Server: POST /apple/login
    Server->>Apple: POST https://appleid.apple.com/auth/token
    Apple->>Server: Identity Tokenè¿”å´

    alt ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœªç™»éŒ²ã®å ´åˆ
        Server->>Cognito: SignUp
    end

    Server->>Cognito: InitiateAuth(CUSTOM_AUTH)
    Cognito-->>Server: ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿”å´
    Server->>Cognito: RespondToAuthChallenge
    Cognito-->>Server: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³è¿”å´

    Server->>Server: ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
    Server-->>Client: ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿”å´
    Client->>Server: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ä»¥é™ã®APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```

# å®Ÿè£…æ‰‹é †

## Appleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…

å…¬å¼ã®[Verifying a user](https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_rest_api/verifying_a_user)ã‚’å‚è€ƒã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

### Request body

å®Ÿéš›ã¯`nonce`ãªã©ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯çœç•¥ã—ã¾ã™ã€‚

```go
type AppleLoginRequest struct {
  AuthorizationCode string `json:"authorization_code" binding:"required"`
}
```

### Authorization Codeã‚’ä½¿ã£ã¦Identity Tokenã‚’å–å¾—

ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã®æ¤œè¨¼å¾Œã€Authorization Codeã‚’ä½¿ã£ã¦ã€Apple Id Serverã‹ã‚‰Identity Tokenã‚’å–å¾—ã—ã¾ã™ã€‚
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§Authorization Codeã¨ä¸€ç·’ã«Identity Tokenã‚‚å–å¾—ã§ãã¾ã™ãŒã€ã‚µãƒ¼ãƒãƒ¼å´ã§Authorization Codeã‚’ä½¿ã£ã¦Apple Id Serverã‹ã‚‰Identity Tokenã‚’å–å¾—ã™ã‚‹æ–¹ãŒã‚ˆã‚Šã‚»ã‚­ãƒ¥ã‚¢ã§ã™ã€‚
ã¾ãŸã€Authorization Codeã¯1åº¦ã—ã‹ä½¿ãˆãšã€5åˆ†é–“ã®ã¿æœ‰åŠ¹ãªå€¤ã§ã™ã€‚

ä»¥ä¸‹ãŒAuthorization Codeã‹ã‚‰Identity Tokenã‚’å–å¾—ã™ã‚‹APIã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã™ã€‚
https://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens

ä¸Šè¨˜ã®APIã‚’å©ãã‚ã‘ã§ã™ãŒã€æ¸¡ã™ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«[client_secret](https://developer.apple.com/documentation/accountorganizationaldatasharing/creating-a-client-secret)ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚
ã¾ãšã¯ã“ã‚Œã‚’ç”¨æ„ã—ã¾ã—ã‚‡ã†ã€‚

#### Client Secretã®ç”Ÿæˆ

Client Secretã«ã¤ã„ã¦ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ä»¥ä¸‹ã§ã™ã€‚
https://developer.apple.com/documentation/accountorganizationaldatasharing/creating-a-client-secret

Client Secretã¯å›ºå®šå€¤ã§ã¯ãªãã€Apple Developerã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å–å¾—ã§ãã‚‹ç§˜å¯†éµã‚’ä½¿ã£ã¦ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã¾ãŸã€ç”Ÿæˆã™ã‚‹Client Secretã¯æœ‰åŠ¹æœŸé™ã‚‚è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ç„¡åŠ¹ã«ãªã£ã¦ã„ãŸå ´åˆã¯å†ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ç®¡ç†ã—ã¦ã‚ã’ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
https://zenn.dev/ytakaya/articles/a748aa8570fe52

ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå‚è€ƒè¨˜äº‹ã¨ã¯ç•°ãªã‚Šã¾ã™ãŒã€å‡¦ç†å†…å®¹ã¯ã»ã¼åŒã˜ã§ã™ã€‚
`APPLE_TEAM_ID`ã€`APPLE_BUNDLE_ID`ã€`APPLE_SECRET_KEY`ã€`APPLE_KEY_ID`ã¯è‡ªèº«ã®Apple Developerã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ç¢ºèªã§ãã‚‹ã‚‚ã®ã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ä¸Šã§ã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã‚‰ã®å€¤ã¯AWS Secrets Managerãªã©ã‚»ã‚­ãƒ¥ã‚¢ãªæ–¹æ³•ã§ã®ç®¡ç†ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚

:::details apple_client_secret_builder.go

```go:apple_client_secret_builder.go
import (
	"crypto/x509"
	"encoding/pem"
	"errors"
	"sync"
	"time"

	"github.com/lestrrat-go/jwx/v2/jwa"
	"github.com/lestrrat-go/jwx/v2/jws"
	"github.com/lestrrat-go/jwx/v2/jwt"
)

const (
	appleTeamId    = "APPLE_TEAM_ID"
	appleBundleId  = "APPLE_BUNDLE_ID"
	appleSecretKey = "APPLE_SECRET_KEY"
	appleKeyId     = "APPLE_KEY_ID"

	appleClientSecretExpiration     time.Duration = time.Hour * 24
	appleClientSecretValidityPeriod int64         = 60
	appleClientSecretAud            string        = "https://appleid.apple.com"
)

type appleClientSecretBuilder struct {
	payload  appleClientSecretPayload
	signer   jwt.SignEncryptParseOption
	mu       sync.RWMutex
	jwtCache string
}

type appleClientSecretPayload struct {
	iss string
	iat time.Time
	exp time.Time
	aud string
	sub string
}

// Appleã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®æ§‹é€ ä½“ã‚’è¿”å´ã™ã‚‹
func newAppleClientSecretBuilder() (*appleClientSecretBuilder, error) {
	signer, err := getSigner()
	if err != nil {
		return nil, err
	}

	res := &appleClientSecretBuilder{
		payload: appleClientSecretPayload{
			iss: appleTeamId,
			iat: time.Now(),
			exp: time.Now().Add(appleClientSecretExpiration),
			aud: appleClientSecretAud,
			sub: appleBundleId,
		},
		signer: signer,
	}
	_, err = res.getClientSecret(time.Now())
	if err != nil {
		return nil, err
	}

	return res, nil
}

// ç½²åã«ä½¿ç”¨ã™ã‚‹ç§˜å¯†éµã‚’å–å¾—ã™ã‚‹
func getSigner() (jwt.SignEncryptParseOption, error) {
	block, _ := pem.Decode([]byte(appleSecretKey))
	if block == nil {
		return nil, errors.New("failed to parse PEM block containing the key")
	}

	privateKey, err := x509.ParsePKCS8PrivateKey(block.Bytes)
	if err != nil {
		return nil, err
	}

	hdr := jws.NewHeaders()
	if err := hdr.Set(jws.AlgorithmKey, jwa.ES256); err != nil {
		return nil, err
	}
	if err := hdr.Set(jws.KeyIDKey, appleKeyId); err != nil {
		return nil, err
	}
	signer := jwt.WithKey(jwa.ES256, privateKey, jws.WithProtectedHeaders(hdr))

	return signer, nil
}

// client secretãŒæœ‰åŠ¹æœŸé™åˆ‡ã‚Œã‹ã©ã†ã‹ã‚’è¿”å´ã™ã‚‹
// 1åˆ†å‰æ™‚ç‚¹ã§æœ‰åŠ¹æœŸé™åˆ‡ã‚Œã¨ã¿ãªã™
func (c *appleClientSecretBuilder) isExpired(at time.Time) bool {
	return c.payload.exp.Unix()-at.Unix() <= appleClientSecretValidityPeriod
}

// client secretã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã™ã‚‹
func (c *appleClientSecretBuilder) getJWTCache(at time.Time) (string, error) {
	c.mu.RLock()
	defer c.mu.RUnlock()
	if c.jwtCache == "" {
		return "", errors.New("apple client secret not found")
	}

	if c.isExpired(at) {
		return "", errors.New("apple client secret expired")
	}
	return c.jwtCache, nil
}

// client secretã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã™ã‚‹
func (c *appleClientSecretBuilder) setJWTCache(jwt string) {
	c.mu.Lock()
	defer c.mu.Unlock()
	c.jwtCache = jwt
}

// JWTã‚’ç”Ÿæˆã™ã‚‹
// https://developer.apple.com/documentation/accountorganizationaldatasharing/creating-a-client-secret
func (c *appleClientSecretBuilder) createJWT() (string, error) {
	t, err := jwt.NewBuilder().
		Issuer(c.payload.iss).
		IssuedAt(c.payload.iat).
		Expiration(c.payload.exp).
		Audience([]string{c.payload.aud}).
		Subject(c.payload.sub).
		Build()
	if err != nil {
		return "", err
	}

	signed, err := jwt.Sign(t, c.signer)
	if err != nil {
		return "", err
	}

	return string(signed), nil
}

// client secretã‚’è¿”å´ã™ã‚‹
// æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹å ´åˆã¯æ–°ã—ã„client secretã‚’ç”Ÿæˆã—ã¦è¿”å´ã™ã‚‹
func (c *appleClientSecretBuilder) getClientSecret(at time.Time) (string, error) {
	j, err := c.getJWTCache(at)
	if err == nil {
		return j, nil
	}

	c.payload.iat = at
	c.payload.exp = at.Add(appleClientSecretExpiration)

	j, err = c.createJWT()
	if err != nil {
		return "", err
	}
	c.setJWTCache(j)

	return j, nil
}
```

:::

#### Generate and validate tokens Endpointã‚’å©ã

Client SecretãŒå–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã‚‰ã€Appleã®[Generate and validate tokens](https://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens)ã‚’å©ãã€Identity Tokenã‚’å–å¾—ã—ã¾ã™ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼ãŒ`application/x-www-form-urlencoded`ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã¨`TokenResponse`ãŒå–å¾—ã§ãã‚‹ã®ã§ã€`TokenResponse.IdToken`ã‹ã‚‰Identity Tokenã‚’å‚ç…§ã§ãã¾ã™ã€‚

:::details apple.go

```go:apple.go
package main

import (
	"context"
	"encoding/json"
	"errors"
	"fmt"
	"io"
	"net"
	"net/http"
	"net/url"
	"reflect"
	"strings"
	"time"

	"github.com/lestrrat-go/jwx/v2/jwk"
)

const (
	appleBundleId string = "APPLE_BUNDLE_ID"

	appleEndpointOrigin string = "https://appleid.apple.com"
	appleJWKsUrl        string = "https://appleid.apple.com/auth/keys"

	generateAndValidateTokensPath string = "auth/token"
)

type AppleClient struct {
	client              *http.Client
	origin              *url.URL
	jwkCache            *jwk.Cache
	clientSecretBuilder *appleClientSecretBuilder
}

func newAppleClient(ctx context.Context) (*AppleClient, error) {
	origin, err := url.Parse(appleEndpointOrigin)
	if err != nil {
		return nil, err
	}

	jwkCache := jwk.NewCache(ctx)
	err = jwkCache.Register(appleJWKsUrl, jwk.WithRefreshInterval(15*time.Minute))
	if err != nil {
		return nil, err
	}

	appleClientSecretBuilder, err := newAppleClientSecretBuilder()
	if err != nil {
		return nil, err
	}

	return &AppleClient{
		client: &http.Client{
			Timeout: 5 * time.Second,
		},
		origin:              origin,
		jwkCache:            jwkCache,
		clientSecretBuilder: appleClientSecretBuilder,
	}, nil
}

// https://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens
type generateAndValidateTokensReq struct {
	ClientId     string                             `form:"client_id"`
	ClientSecret string                             `form:"client_secret"`
	Code         *string                            `form:"code"`
	GrantType    generateAndValidateTokensGrantType `form:"grant_type"`
	RefreshToken *string                            `form:"refresh_token"`
	RedirectUri  *string                            `form:"redirect_uri"`
}

type generateAndValidateTokensGrantType string

const (
	GenerateAndValidateTokensGrantTypeAuthorizationCode generateAndValidateTokensGrantType = "authorization_code"
	GenerateAndValidateTokensGrantTypeRefreshToken      generateAndValidateTokensGrantType = "refresh_token"
)

// https://appleid.apple.com/auth/token ã®æ­£å¸¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹
// https://developer.apple.com/documentation/sign_in_with_apple/tokenresponse
type tokenResponse struct {
	AccessToken  string `json:"access_token"`
	ExpiresIn    int    `json:"expires_in"`
	IdToken      string `json:"id_token"`
	RefreshToken string `json:"refresh_token"`
	TokenType    string `json:"token_type"`
}

// https://appleid.apple.com/auth/token ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
// https://developer.apple.com/documentation/sign_in_with_apple/errorresponse
type appleErrorResponse struct {
	Error            string `json:"error"`
	ErrorDescription string `json:"error_description"`
}

// Validate an authorization grant code delivered to your app to obtain tokens, or validate an existing refresh token.
// https://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens
func (a *AppleClient) generateAndValidateTokens(ctx context.Context, code *string, grantType generateAndValidateTokensGrantType, refreshToken *string, redirectUri *string) (*tokenResponse, error) {
	clientSecret, err := a.clientSecretBuilder.getClientSecret(time.Now())
	if err != nil {
		return nil, err
	}

	_, bodyBytes, err := a.doRequest(
		ctx,
		http.MethodPost,
		generateAndValidateTokensPath,
		&generateAndValidateTokensReq{
			ClientId:     appleBundleId,
			ClientSecret: clientSecret,
			Code:         code,
			GrantType:    grantType,
			RedirectUri:  redirectUri,
			RefreshToken: refreshToken,
		},
	)
	if err != nil {
		return nil, err
	}
	var tokenResponse tokenResponse
	if err := json.Unmarshal(bodyBytes, &tokenResponse); err != nil {
		return nil, err
	}

	return &tokenResponse, nil
}

func (a *AppleClient) doRequest(ctx context.Context, method string, path string, body any) (*http.Response, []byte, error) {
	endpoint := a.origin.JoinPath(path)
	data := encodeStructToValues(body)
	req, err := http.NewRequestWithContext(ctx, method, endpoint.String(), data)
	if err != nil {
		return nil, nil, err
	}
	req.Header.Set("Content-Type", "application/x-www-form-urlencoded")

	res, err := a.client.Do(req)
	if err != nil {
		var ne net.Error
		if errors.As(err, &ne) && ne.Timeout() {
			return nil, nil, fmt.Errorf("failed to get token: timeout: %w", err)
		}
		return nil, nil, err
	}
	defer func() {
		err := res.Body.Close()
		if err != nil {
			log.Printf("failed to close response body: %v", err)
		}
	}()

	if res.StatusCode != http.StatusOK {
		bodyBytes, err := io.ReadAll(res.Body)
		if err != nil {
			return nil, nil, err
		}
		var errorResponse appleErrorResponse
		if err := json.Unmarshal(bodyBytes, &errorResponse); err != nil {
			return nil, nil, err
		}

		return nil, nil, fmt.Errorf("failed to get token: error: %s, description: %s", errorResponse.Error, errorResponse.ErrorDescription)
	}

	bodyBytes, err := io.ReadAll(res.Body)
	if err != nil {
		return nil, nil, err
	}
	return res, bodyBytes, nil
}

func encodeStructToValues(i any) *strings.Reader {
	values := url.Values{}
	iVal := reflect.ValueOf(i).Elem()
	iType := iVal.Type()
	for i := range iVal.NumField() {
		tag := iType.Field(i).Tag.Get("form")
		if tag == "" {
			continue
		}

		f := iVal.Field(i)
		if f.Kind() == reflect.Ptr {
			if f.IsNil() {
				continue
			}
			f = f.Elem()
		}
		values.Set(tag, fmt.Sprintf("%v", f.Interface()))
	}

	return strings.NewReader(values.Encode())
}
```

:::

### Identity Tokenã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—

Identity Tokenè‡ªä½“ã¯JWTã§æ§‹æˆã•ã‚Œã¦ãŠã‚Šã€ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_rest_api/authenticating_users_with_sign_in_with_apple#3383773

ãã®ä¸­ã§Cognitoã¸ã®ç™»éŒ²ã«å¿…è¦ãªæƒ…å ±ã‚’JWTã‹ã‚‰å–ã‚Šå‡ºã—ã¾ã™ã€‚
ä»Šå›å–ã‚Šå‡ºã™å€¤ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

- `sub`
    - `The subject registered claim identifies the principal thatâ€™s the subject of the identity token. Because this token is for your app, the value is the unique identifier for the user.`
    - `Because this token is for your app, the value is the unique identifier for the user.`ã¨ã‚ã‚‹é€šã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è­˜åˆ¥å­ã«ä½¿ã„ã¾ã™ã€‚

- `email`
    - `A string value that represents the userâ€™s email address. The email address is either the userâ€™s real email address or the proxy address, depending on their private email relay service. This value may be empty for Sign in with Apple at Work & School users. For example, younger students may not have an email address.`
    - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAppleã«ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã¾ãŸã¯AppleãŒç™ºè¡Œã™ã‚‹ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå–å¾—ã§ãã¾ã™ã€‚
        - ã©ã¡ã‚‰ãŒå–å¾—ã§ãã‚‹ã‹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆã‚ã¦ãã®ã‚¢ãƒ—ãƒªã§Appleãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹éš›ã«å‡ºã‚‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®é¸æŠæ¬¡ç¬¬ã§æ±ºã¾ã‚Šã¾ã™ã€‚
			![](/images/d77b038c51d4f4/gogh-first-sign-in-with-apple.png =250x)
            - Share My Email(ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…±æœ‰ã«ã—ãŸå ´åˆ)
                - Appleã«ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå–å¾—ã§ãã¾ã™ã€‚
            - Hide My Email(ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’éå…±æœ‰ã«ã—ãŸå ´åˆ)
                - AppleãŒç™ºè¡Œã™ã‚‹ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå–å¾—ã§ãã¾ã™ã€‚
    - ã¾ãŸã€`This value may be empty for Sign in with Apple at Work & School users. For example, younger students may not have an email address.`ã¨ã‚ã‚‹é€šã‚Šã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã§ããªã„ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ã®ã§ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãªã„å ´åˆã‚‚è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### Cognitoã¸ã®ç™»éŒ²ã€œã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã¾ã§

ä»Šå›ã®Cognitoã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã¯ã€é€šå¸¸ã®ãƒ•ãƒ­ãƒ¼ã§ã¯ãªãã€`Custom authentication challenge Lambda triggers`ã‚’ä½¿ã„ã¾ã™ã€‚

https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-challenge.html

æœ¬è¨˜äº‹ã¨è¢«ã‚‹å†…å®¹ã‚‚å¤šã€…ã‚ã‚Šã¾ã™ãŒã€ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒå¤§å¤‰å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚
https://nickjones.tech/aws-cognito-siwa-native/

ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã®ãƒ•ãƒ­ãƒ¼(å…¬å¼ã‹ã‚‰æŠœç²‹)
![](/images/d77b038c51d4f4/lambda-challenges.png)

ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã‚’å®Ÿè£…ã™ã‚‹ã«ã‚ãŸã£ã¦ã¯ã€4ã¤ã®Lambdaã‚’ç”¨æ„ã—ã€Cognitoã¨ç´ã¥ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- Define auth challenge
    - ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã®ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚
    - ãƒ•ãƒ­ãƒ¼ã«ã‚ã‚‹é€šã‚Šã€ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã‚’é–‹å§‹ã™ã‚‹ã¨ãã¨ã€Verify auth challengeãŒçµ‚ã‚ã£ãŸå¾Œã«å®Ÿè¡Œã•ã‚Œã¦ãŠã‚Šã€æ–°ã—ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é–‹å§‹ã—ãŸã‚Šã€èªè¨¼ã‚’å®Œäº†ã¾ãŸã¯ä¸­æ­¢ã™ã‚‹ã‹ã‚’æ±ºå®šã™ã‚‹ã‚‚ã®ã§ã™ã€‚

- Create auth challenge
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦CAPTCHAã¸ã®ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã—ãŸã‚Šãªã©ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦èªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ç”¨æ„ã™ã‚‹ã‚‚ã®ã§ã™ã€‚
    - ä»Šå›ã®SIWAã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼å´ã§å–å¾—ã—ãŸIdentityTokenã‚’æ¤œè¨¼ã™ã‚‹ã ã‘ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦è¿½åŠ ã®èªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¯è¨­ã‘ãªã„ã®ã§ã€ã“ã®Lambdaã«ã¯ç‰¹ã«å‡¦ç†ã‚’æ›¸ãã¾ã›ã‚“ã€‚

- Verify auth challenge
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
    - ä»Šå›ã®SIWAã§ã¯ã€IdentityTokenã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

- Pre sign-up Lambda trigger
    - ä¸Šè¨˜ã®Lambdaã ã‘ã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœªèªè¨¼çŠ¶æ…‹ã®ãŸã‚ã€ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã€‚Pre sign-up Lambda triggerã®ä¸­ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼æ¸ˆã¿ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ã¨ã‚ã‚‹ã¨ã€Cognitoã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã¾ã§ã®æµã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ãƒ­ãƒ¼ã§ã™ã€‚

```mermaid
sequenceDiagram
    autonumber
    participant Server as Server
    participant Cognito as Cognito
    participant PreSignUpLambda as PreSignUp Lambda
	participant DefineAuthLambda as DefineAuth Lambda
	participant CreateAuthLambda as CreateAuth Lambda
	participant VerifyAuthLambda as VerifyAuth Lambda

    Server ->> Cognito: AdminGetUser(find by sub)
    Cognito -->> Server: User
    alt User does not exist
        Server ->> Cognito: SignUp(with random password)
        Cognito ->> PreSignUpLambda: Trigger
        PreSignUpLambda -->> Cognito: Confirm User
    end
    rect rgb(191, 223, 255)
        Note over Server: Cognito custom authentication
        Server ->> Cognito: InitiateAuth
		Cognito ->> DefineAuthLambda: Start Session
		DefineAuthLambda -->> Cognito: CUSTOM_CHALLENGE
		Cognito ->> CreateAuthLambda: Issue challenge
		CreateAuthLambda -->> Cognito: No Challenge
		Cognito -->> Server: Session
		Server ->> Cognito: RespondToAuthChallenge
		Cognito ->> VerifyAuthLambda: Verify Apple's identity token
		VerifyAuthLambda -->> Cognito: Verification result
		Cognito ->> DefineAuthLambda: Challenge result
		DefineAuthLambda -->> Cognito: Issue tokens
		Cognito -->> Server: Access token
    end
```

ãƒ•ãƒ­ãƒ¼ã®åˆã‚ã‹ã‚‰é †ç•ªã«è§£èª¬ã™ã‚‹å‰ã«ã€ã¾ãšã¯ä¸Šè¨˜ã§æŒ™ã’ãŸ4ã¤ã®Lambdaã®ç™»éŒ²ã¨Cognitoã¨ã®ç´ä»˜ã‘ã®ä»•æ–¹ã‚’è§£èª¬ã—ã¾ã™ã€‚

#### Lambdaã®ä½œæˆã¨Cognitoã¨ã®ç´ä»˜ã‘è¨­å®š

##### Define Auth Lambda

https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-define-auth-challenge.html

ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã®ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ç®¡ç†ã™ã‚‹Lambdaã§ã™ã€‚
ä¸Šè¨˜ã®ãƒ•ãƒ­ãƒ¼ã«ã‚ã‚‹é€šã‚Šã€ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã‚’é–‹å§‹ã™ã‚‹ã¨ãã¨ã€èªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸(VerifyAuth Lambda)ãŒå®Œäº†ã—ãŸå¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

`event.Request.Session`ãŒ`0`ã®ã¨ãã€ã¤ã¾ã‚Šã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã‚’é–‹å§‹ã™ã‚‹ã¨ãã¯`event.Response.ChallengeName`ã«`CUSTOM_CHALLENGE`ã‚’è¨­å®šã—ã¦ã‚ã’ã¾ã™ã€‚

`0`ä»¥å¤–ã®ã¨ãã¯ã€èªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒå®Œäº†ã—ãŸå¾Œãªã®ã§ã€VerifyAuth Lambdaã®çµæœã§ã‚ã‚‹`ChallengeResult`ã‚’å…ƒã«ã€`event.Response.IssueTokens`ãŠã‚ˆã³`event.Response.FailAuthentication`ã«è¨­å®šã—ã¦ã‚ã’ã¾ã™ã€‚

```go:src/custom_auth/define_auth/main.go
package main

import (
	"context"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
)

func main() {
	lambda.Start(handler)
}

func handler(ctx context.Context, event events.CognitoEventUserPoolsDefineAuthChallenge) (events.CognitoEventUserPoolsDefineAuthChallenge, error) {
	if len(event.Request.Session) == 0 {
		// èªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒæœªå®Ÿæ–½ã®ã¨ã
		// èªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸åã‚’è¨­å®šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ–°ã—ã„èªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’æç¤ºã™ã‚‹
		event.Response.IssueTokens = false
		event.Response.FailAuthentication = false
		event.Response.ChallengeName = "CUSTOM_CHALLENGE"
		return event, nil
	} else {
		// èªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒå®Œäº†ã—ã¦ã„ã‚‹ã¨ã
		// issueTokens: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ååˆ†ã«å®Œäº†ã—ãŸå ´åˆã¯true
		// failAuthentication: ç¾åœ¨ã®èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ã™ã‚‹å ´åˆã¯true
		challengeResult := event.Request.Session[len(event.Request.Session)-1]
		if challengeResult.ChallengeName == "CUSTOM_CHALLENGE" {
			event.Response.IssueTokens = challengeResult.ChallengeResult
			event.Response.FailAuthentication = !challengeResult.ChallengeResult
			return event, nil
		}
	}

	return event, nil
}
```

##### Create Auth Lambda

https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-create-auth-challenge.html

èªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ä½œæˆã™ã‚‹Lambdaã§ã™ãŒã€ä»Šå›ã®SIWAã§ã¯JWTã‚’æ¤œè¨¼ã™ã‚‹ä½œæ¥­ã ã‘ãªã®ã§ã€å‡¦ç†ã‚‰ã—ã„å‡¦ç†ã¯æ›¸ãã¾ã›ã‚“ã€‚

```go:src/custom_auth/create_auth/main.go
package main

import (
	"context"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
)

func main() {
	lambda.Start(handler)
}

func handler(ctx context.Context, event events.CognitoEventUserPoolsCreateAuthChallenge) (events.CognitoEventUserPoolsCreateAuthChallenge, error) {
	return event, nil
}
```

##### Verify Auth Lambda

https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-verify-auth-challenge-response.html

ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã®è¦ã§ã™ã€‚ã“ã“ã§ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸJWTã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
é•·ã„ã®ã§æŠ˜ã‚ŠãŸãŸã‚“ã§ã„ã¾ã™ã€‚

nonceã®æ¤œè¨¼ã¨JWTã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
`APPLE_BUNDLE_ID`ã¯æ›¸ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

:::details verify auth

```go:src/custom_auth/verify_auth/main.go
package main

import (
	"context"
	"custom_auth/verify_auth/executor"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
)

func main() {
	lambda.Start(handler)
}

func handler(ctx context.Context, event events.CognitoEventUserPoolsVerifyAuthChallenge) (events.CognitoEventUserPoolsVerifyAuthChallenge, error) {
	if err := executor.Execute(ctx, event); err != nil {
		return event, err
	}

	// èªè¨¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’å®Œäº†ã™ã‚‹
	event.Response.AnswerCorrect = true
	return event, nil
}
```

<!-- cSpell:disable -->
```go:verify_auth/executor/executor.go
package executor

import (
	"context"
	"custom_auth/verify_auth/services"
	"encoding/json"

	"github.com/aws/aws-lambda-go/events"
	"github.com/cockroachdb/errors"
	"github.com/go-playground/validator/v10"
)

var (
	validate *validator.Validate
)

type ServiceProvider string

const (
	ServiceProviderApple ServiceProvider = "apple"
)

func (s ServiceProvider) IsValid() bool {
	switch s {
	case ServiceProviderApple:
		return true
	default:
		return false
	}
}

type Payload struct {
	Provider      ServiceProvider `json:"provider" validate:"required"`
	Nonce         string          `json:"nonce" validate:"required"`
	IdentityToken string          `json:"identity_token" validate:"required"`
}

func init() {
	validate = validator.New(validator.WithRequiredStructEnabled())
}

func Execute(ctx context.Context, event events.CognitoEventUserPoolsVerifyAuthChallenge) error {
	var payload Payload
	if err := json.Unmarshal([]byte(event.Request.ChallengeAnswer.(string)), &payload); err != nil {
		return err
	}
	err := validate.Struct(payload)
	if err != nil {
		return errors.Wrap(err, "invalid payload")
	}
	if !payload.Provider.IsValid() {
		return errors.Wrapf(err, "invalid provider: %s", payload.Provider)
	}

	// çœç•¥: nonceã®æ¤œè¨¼

	switch payload.Provider {
	case ServiceProviderApple:
		if err := VerifyAppleIdentityToken(ctx, event, payload); err != nil {
			return errors.Wrap(err, "failed to verify apple identity token")
		}
	default:
		return errors.Newf("unsupported provider: %s", payload.Provider)
	}

	return nil
}

func VerifyAppleIdentityToken(ctx context.Context, event events.CognitoEventUserPoolsVerifyAuthChallenge, payload Payload) error {
	appleClient, err := services.GetAppleClient(ctx)
	if err != nil {
		return err
	}

	sub, err := appleClient.VerifyIdentityToken(ctx, payload.IdentityToken, payload.Nonce, false)
	if err != nil {
		return errors.Wrap(err, "failed to verify identity token")
	}

	if event.UserName != sub {
		return errors.Newf("incorrect user name: event.UserName: %s, sub: %s", event.UserName, sub)
	}

	return nil
}
```

```go:verify_auth/services/apple_client.go
package services

import (
	"context"
	"net/http"
	"net/url"
	"slices"
	"strings"
	"time"

	"github.com/cockroachdb/errors"

	"github.com/lestrrat-go/jwx/v2/jwk"
	"github.com/lestrrat-go/jwx/v2/jwt"
)

const (
	appleBundleId string = "APPLE_BUNDLE_ID"

	appleEndpointOrigin string = "https://appleid.apple.com"
	appleJWKsUrl        string = "https://appleid.apple.com/auth/keys"
)

var appleClient *AppleClient

type AppleClient struct {
	jwkCache *jwk.Cache
}

func GetAppleClient(ctx context.Context) (*AppleClient, error) {
	if appleClient != nil {
		return appleClient, nil
	}

	jwkCache := jwk.NewCache(ctx)
	err := jwkCache.Register(appleJWKsUrl, jwk.WithRefreshInterval(15*time.Minute))
	if err != nil {
		return nil, err
	}

	appleClient = &AppleClient{
		jwkCache: jwkCache,
	}

	return appleClient, nil
}

// Appleã®å…¬é–‹éµã‚’å–å¾—ã™ã‚‹
// forceãŒtrueã®å ´åˆã¯å¼·åˆ¶çš„ã«å–å¾—ã—ç›´ã™
func (a *AppleClient) getPublicKey(ctx context.Context, force bool) (jwk.Set, error) {
	if force {
		return a.jwkCache.Refresh(ctx, appleJWKsUrl)
	} else {
		return a.jwkCache.Get(ctx, appleJWKsUrl)
	}
}

// Appleã®Identity Token(JWT)ã‚’æ¤œè¨¼ã™ã‚‹
// æ¤œè¨¼ã«æˆåŠŸã—ãŸæ™‚ã€Identity Tokenã«ã‚ã‚‹`subject`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿”å´ã™ã‚‹
// `subject`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥å­ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹
func (a *AppleClient) VerifyIdentityToken(ctx context.Context, idToken string, expectedNonce string, force bool) (string, error) {
	key, err := a.getPublicKey(ctx, force)
	if err != nil {
		return "", errors.Wrap(err, "failed to get public key")
	}

	// å…¬é–‹éµã‚’ä½¿ç”¨ã—ã¦ç½²åã‚’æ¤œè¨¼ã™ã‚‹
	token, err := jwt.Parse([]byte(idToken), jwt.WithKeySet(key))
	if err != nil {
		// ç½²åã«å¤±æ•—ã—ã€å…¬é–‹éµãŒæœ‰åŠ¹æœŸé™åˆ‡ã‚Œã®å ´åˆã€å…¬é–‹éµã‚’å†å–å¾—ã—ã¦å†åº¦æ¤œè¨¼ã‚’è¡Œã†
		// forceãŒtrueã®å ´åˆã¯ãƒ«ãƒ¼ãƒ—ã‚’é˜²ããŸã‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
		if strings.Contains(err.Error(), "failed to find key") && !force {
			return a.VerifyIdentityToken(ctx, idToken, expectedNonce, true)
		}
		return "", err
	}

	// nonceã®æ¤œè¨¼
	nonce, ok := token.Get("nonce")
	if !ok {
		return "", errors.New("cannot find nonce from given token")
	}
	if nonce != expectedNonce {
		return "", errors.Newf("nonce mismatch: expected %s, got %s", expectedNonce, nonce)
	}

	// issãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
	// `https://appleid.apple.com`ã‹ã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
	if token.Issuer() != appleEndpointOrigin {
		return "", errors.Newf("invalid issuer: expected %s, got %s", appleEndpointOrigin, token.Issuer())
	}

	// audãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
	// Apple Developerã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ç¢ºèªã§ãã‚‹Bundle IDã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
	if !slices.Contains(token.Audience(), appleBundleId) {
		return "", errors.Newf("invalid audience: does not contain %s in %s", appleBundleId, token.Audience())
	}

	// ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šå¾Œã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
	if token.Expiration().Before(time.Now()) {
		return "", errors.Newf("token expired: %s", token.Expiration())
	}

	return token.Subject(), nil
}
```
<!-- cSpell:enable -->

:::

##### Pre sign-up Lambda

ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å¾Œã«èªè¨¼æ¸ˆã¿ã«ã—ã¾ã™ã€‚
é€šå¸¸ã®ãƒ•ãƒ­ãƒ¼ã§ã‚‚ã“ã®Lambdaã¯å®Ÿè¡Œã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€ãƒã‚§ãƒƒã‚¯ã‚’è¨­ã‘ã¾ã™ã€‚

<!-- cSpell:disable -->
```go:src/custom_auth/pre_sign_up/main.go
package main

import (
	"context"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
)

const (
	thirdPartyKey = "third_party"
)

func main() {
	lambda.Start(handler)
}

func handler(ctx context.Context, event events.CognitoEventUserPoolsPreSignup) (events.CognitoEventUserPoolsPreSignup, error) {
	v, ok := event.Request.ClientMetadata[thirdPartyKey]
	if ok && v == "true" {
		event.Response.AutoConfirmUser = true
		return event, nil
	}

	return event, nil
}
```
<!-- cSpell:enable -->

##### Cognitoã¨ã®ç´ä»˜ã‘

Lambdaã‚’ä½œæˆå¾Œã€Cognitoã¨ç´ä»˜ã‘ã¾ã™ã€‚
ã“ã“ã§ã¯`AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«`ã¨`AWS CDK`ãã‚Œãã‚Œã®è¨­å®šæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

###### AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«

AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã ã¨ã€ä½¿ç”¨ã—ã¦ã„ã‚‹Cognito User Poolã‹ã‚‰Extensionsã«è¡Œãã“ã¨ã§ã€Lambda Triggersã‚’ç¢ºèªã§ãã¾ã™ã€‚

![](/images/d77b038c51d4f4/cognito-extensions.jpg)

Add Lambda triggerã‚’æŠ¼ä¸‹ã—ã€ä»¥ä¸‹ã®ç”»é¢ã®ã‚ˆã†ã«Trigger typeã‚’Custom authenticationã«ã—ã¦ã€Custom authenticationã¨Assign Lambda functionã«ä½œæˆã—ãŸLambdaã‚’è¨­å®šã—ã¾ã™ã€‚

Pre sign-upã«é–¢ã—ã¦ã¯ã€Trigger typeã‚’Sign-upã«ã™ã‚‹ã“ã¨ã§Pre sign-up triggerã‚’è¨­å®šã§ãã¾ã™ã€‚

![](/images/d77b038c51d4f4/cognito-add-lambda-trigger.png)

###### AWS CDK

Iacã¨ã—ã¦AWS CDKã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚
[goghã§ã¯golangã‚’ä½¿ç”¨ã—ã¦AWS CDKã‚’æ›¸ã„ã¦ã„ã‚‹ãŸã‚](https://zenn.dev/ambr_inc/articles/87352ca4ba7436)ã€ä¸‹è¨˜ã¯golangã®ã‚³ãƒ¼ãƒ‰ä¾‹ã§ã™ã€‚

::::details Code

ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§ã™ã€‚

```text
src
â”” custom_auth
ã€€ â”œ create_auth
ã€€ â”‚ â”” main.go
ã€€ â”œ define_auth
ã€€ â”‚ â”” main.go
ã€€ â”œ pre_sign_up
ã€€ â”‚ â”” main.go
ã€€ â”œ verify_auth
ã€€ â”‚ â”” main.go
ã€€ â”œ go.mod
ã€€ â”” go.sum
docker
â”” custom_auth
ã€€ â”” Dockerfile
cdk
â”” database
ã€€ â”” id
ã€€ ã€€ â”” cognito.go
```

:::message
CDKã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã®è¨­å®šã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã™ã‚‹ãŸã‚ã€ãã®ä»–ã®è¨­å®šé …ç›®ã«ã¤ã„ã¦ã¯çœç•¥ã—ã¦ã„ã¾ã™ã€‚
:::

<!-- cSpell:disable -->
```go:cdk/database/id/cognito.go
package id

import (
	"github.com/aws/aws-cdk-go/awscdk/v2"
	"github.com/aws/aws-cdk-go/awscdk/v2/awscognito"
	"github.com/aws/aws-cdk-go/awscdk/v2/awsecrassets"
	"github.com/aws/aws-cdk-go/awscdk/v2/awslambda"
	"github.com/aws/constructs-go/constructs/v10"
	"github.com/aws/jsii-runtime-go"
)

type CognitoStackProps struct {
	awscdk.StackProps
}

func NewCognito(scope constructs.Construct, props *CognitoStackProps) awscdk.Stack {
	var sprops awscdk.StackProps
	if props != nil {
		sprops = props.StackProps
	}

	stack := awscdk.NewStack(scope, jsii.String("cognito-stack"), &sprops)

	// ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ç”¨Lambda
	defineAuthLambda := newCustomAuthLambda(&stack, "define_auth")
	createAuthLambda := newCustomAuthLambda(&stack, "create_auth")
	verifyAuthLambda := newCustomAuthLambda(&stack, "verify_auth")
	preSignUpLambda := newCustomAuthLambda(&stack, "pre_sign_up")

	// Cognito User Poolã®ä½œæˆ
	awscognito.NewUserPoolClient(stack, jsii.String("user-pool-client"), &awscognito.UserPoolClientProps{
		UserPool: awscognito.NewUserPool(stack, jsii.String("user-pool"), &awscognito.UserPoolProps{
			UserPoolName: jsii.String("my-user-pool"),
			LambdaTriggers: &awscognito.UserPoolTriggers{
				DefineAuthChallenge:         defineAuthLambda,
				CreateAuthChallenge:         createAuthLambda,
				VerifyAuthChallengeResponse: verifyAuthLambda,
				PreSignUp:                   preSignUpLambda,
			},
		}),
		AuthFlows: &awscognito.AuthFlow{
			Custom: jsii.Bool(true),
		},
	})

	return stack
}

func newCustomAuthLambda(stack *awscdk.Stack, targetFolder string) awslambda.Function {
	customAuthAsset := awsecrassets.NewDockerImageAsset(*stack, jsii.String("cognito-"+targetFolder+"-challenge-image"), &awsecrassets.DockerImageAssetProps{
		Directory: jsii.String("../../"),
		File:      jsii.String("docker/custom_auth/Dockerfile"),
		BuildArgs: &map[string]*string{
			"TARGET_FOLDER": &targetFolder,
		},
	})
	customAuthLambda := awslambda.NewFunction(*stack, jsii.String("cognito-"+targetFolder+"-challenge-lambda"), &awslambda.FunctionProps{
		FunctionName: jsii.String("cognito-" + targetFolder + "-challenge"),
		Runtime:      awslambda.Runtime_FROM_IMAGE(),
		Handler:      awslambda.Handler_FROM_IMAGE(),
		Architecture: awslambda.Architecture_ARM_64(),
		Code: awslambda.AssetCode_FromEcrImage(customAuthAsset.Repository(), &awslambda.EcrImageCodeProps{
			TagOrDigest: customAuthAsset.ImageTag(),
		}),
		MemorySize: jsii.Number(128),
		Timeout:    awscdk.Duration_Seconds(jsii.Number(10)),
	})

	return customAuthLambda
}
```
<!-- cSpell:enable -->

Dockerfileã§ã™ã€‚[distroless](https://github.com/GoogleContainerTools/distroless)ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
æ³¨æ„ç‚¹ã¨ã—ã¦ã€FROMã§æŒ‡å®šã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯åŸºæœ¬ãƒãƒƒã‚·ãƒ¥ã§å›ºå®šã•ã›ã‚‹ã»ã†ãŒã„ã„ã®ã§ã™ãŒã€distrolessã«é–¢ã—ã¦ã¯ç‰¹ã«å›ºå®šã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã¨ã„ã†ã®ã‚‚ã€distrolessã¯é »ç¹ã«latestã‚¿ã‚°ã‚’æ›´æ–°ã—ã¦ã„ã‚‹ãŸã‚ãƒãƒƒã‚·ãƒ¥ã‚’å›ºå®šã•ã›ãªã„ã§ã„ã‚‹ã¨ã€å‰ã¾ã§ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã§ããŸã®ã«æ€¥ã«å¤±æ•—ã—ãŸã€ãªã‚“ã¦ã“ã¨ãŒèµ·ã“ã‚Šãˆã¾ã™ã€‚
ãƒãƒƒã‚·ãƒ¥ã¯`FROM gcr.io/distroless/static:latest-arm64@sha256:xxxxx`ã®ã‚ˆã†ã«å›ºå®šåŒ–ã§ãã¾ã™ã€‚

:::message
å®Ÿéš›ã«èµ·ã“ã£ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
Dockerfileã®ãƒ“ãƒ«ãƒ‰ã€ECRã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã¾ã§ã¯ã§ãã¦ã„ã¾ã—ãŸãŒã€è‚å¿ƒã®Lambdaã¨ECRã‚¤ãƒ¡ãƒ¼ã‚¸ã®ç´ä»˜ã‘éƒ¨åˆ†ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¦ã„ã¾ã—ãŸã€‚
`'AWS::Lambda::Function' with identifier 'cognito-define_auth-challenge' did not stabilize."`
:::

<!-- cSpell:disable -->
```Dockerfile:docker/custom_auth/Dockerfile
# Builder
FROM public.ecr.aws/docker/library/golang:1.22-alpine AS builder

ENV GO111MODULE=on

WORKDIR /app
COPY ./src/custom_auth .

ARG TARGET_FOLDER
RUN CGO_ENABLED=0 GOARCH=arm64 GOOS=linux go build -ldflags="-s -w" -trimpath -o ./bootstrap ./$TARGET_FOLDER/main.go

# Runner
FROM gcr.io/distroless/static:latest-arm64

COPY --from=builder /app/bootstrap /app/bootstrap

ENTRYPOINT ["/app/bootstrap"]
```
<!-- cSpell:enable -->

::::

#### ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰Cognitoã¸ã®ã‚„ã‚Šå–ã‚Š

Lambdaã¨Cognitoã¨ã®ç´ä»˜ã‘ãŒå®Œäº†ã—ãŸã¨ã“ã‚ã§ã€å®Ÿéš›ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã©ã®ã‚ˆã†ã«Cognitoã¨ã‚„ã‚Šå–ã‚Šã‚’è¡Œãªã£ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã‹ã€[Cognitoã¸ã®ç™»éŒ²ã€œã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã¾ã§](#cognitoã¸ã®ç™»éŒ²ã€œã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã¾ã§)ã§æŒ™ã’ãŸãƒ•ãƒ­ãƒ¼ã‚’é †ç•ªã«è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

##### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ç¢ºèªã¨ç™»éŒ²

Cognitoã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹å‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
ä»¥ä¸‹ã®AdminGetUserã‚’ä½¿ç”¨ã—ã¦ç¢ºèªã—ã¾ã™ã€‚

https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_AdminGetUser.html

Requestã®å†…å®¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

- `UserPoolId`
    - Cognito User Pool IDã‚’è¨­å®šã—ã¾ã™ã€‚
- `Username`
    - [Identity Tokenã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—](#identity-tokenã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—)ã§å–ã‚Šå‡ºã—ãŸ`sub`ã‚’è¨­å®šã—ã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯SignUpã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_SignUp.html

Requestã®å†…å®¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

- `ClientId`
    - Cognito User Pool Client IDã‚’è¨­å®šã—ã¾ã™ã€‚
- `Username`
    - [Identity Tokenã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—](#identity-tokenã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—)ã§å–ã‚Šå‡ºã—ãŸ`sub`ã‚’è¨­å®šã—ã¾ã™ã€‚
- `Password`
    - ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’è¨­å®šã—ã¾ã™ã€‚
- `UserAttributes`
    - [Identity Tokenã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—](#identity-tokenã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—)ã§å–ã‚Šå‡ºã—ãŸ`email`ã‚’ã¤ã‹ã£ã¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚
- `ClientMetadata`
    - `third_party`ã‚’ã‚­ãƒ¼ã«ã€`true`ã‚’ãƒãƒªãƒ¥ãƒ¼ã¨ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚

##### ã‚«ã‚¹ã‚¿ãƒ èªè¨¼

Cognitoã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç”¨æ„ã—ãŸã‚‰ã€ã‚«ã‚¹ã‚¿ãƒ èªè¨¼ã‚’é–‹å§‹ã—ã¾ã™ã€‚
ã¾ãšã€InitiateAuthã‚’ä½¿ã£ã¦èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã•ã›ã¾ã™ã€‚

https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_InitiateAuth.html

Requestã®å†…å®¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

- `ClientId`
    - Cognito User Pool Client IDã‚’è¨­å®šã—ã¾ã™ã€‚
- `AuthFlow`
    - `CUSTOM_AUTH`ã‚’è¨­å®šã—ã¾ã™ã€‚
- `AuthParameters`
    - `USERNAME`ã‚’ã‚­ãƒ¼ã«ã€[Identity Tokenã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—](#identity-tokenã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—)ã§å–ã‚Šå‡ºã—ãŸ`sub`ã‚’ãƒãƒªãƒ¥ãƒ¼ã¨ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚

Responseã¨ã—ã¦`Session`ãŒå–å¾—ã§ããŸã‚‰ã€RespondToAuthChallengeã‚’ä½¿ã£ã¦JWTã®æ¤œè¨¼ã‚’Verify Lambdaã«å®Ÿè¡Œã—ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚

https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_RespondToAuthChallenge.html

Requestã®å†…å®¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

- `ClientId`
    - Cognito User Pool Client IDã‚’è¨­å®šã—ã¾ã™ã€‚
- `Session`
    - InitiateAuthã®Responseã§å–å¾—ã—ãŸ`Session`ã‚’è¨­å®šã—ã¾ã™ã€‚
- `ChallengeName`
    - `CUSTOM_CHALLENGE`ã‚’è¨­å®šã—ã¾ã™ã€‚
- `ChallengeResponses`
    - ä»¥ä¸‹ã®2ã¤ã‚’è¨­å®šã—ã¾ã™ã€‚
        - `USERNAME`ã‚’ã‚­ãƒ¼ã«ã€[Identity Tokenã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—](#identity-tokenã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–å¾—)ã§å–ã‚Šå‡ºã—ãŸ`sub`ã‚’ãƒãƒªãƒ¥ãƒ¼ã¨ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚
        - `ANSWER`ã‚’ã‚­ãƒ¼ã«ã€ä»¥ä¸‹ã®æ§‹é€ ä½“ã‚’`json.Marshal`ã—ãŸçµæœã‚’ãƒãƒªãƒ¥ãƒ¼ã¨ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚

		  :::message
		  `verify_auth/executor/executor.go`ã«ã‚ã‚‹`Payload`æ§‹é€ ä½“ã¨åˆã‚ã›ã¾ã™ã€‚
		  :::

          ```go
		  type CustomAuthAnswer struct {
			Provider      ServiceProvider `json:"provider"`
			Nonce         string          `json:"nonce"`
			IdentityToken string          `json:"identity_token"`
		  }
		  ```

Responseã¨ã—ã¦`AccessToken`ã‚„`RefreshToken`ãŒå–å¾—ã§ãã¾ã™ã€‚

### Apple Refresh Tokenã®ä¿å­˜

Cognitoã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã‚’å–å¾—ã—ãŸå¾Œã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™»éŒ²ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆãªã©ã‚’è¡Œã„ã¾ã™ãŒã€è¿½åŠ ã§[Generate and validate tokens Endpointã‚’å©ã](#generate-and-validate-tokens-endpointã‚’å©ã)ã§å–å¾—ã—ãŸ`TokenResponse.RefreshToken`ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

Appleã®Refresh Tokenã‚’ä¿å­˜ã™ã‚‹ç›®çš„ã¨ã—ã¦ã¯ã€ã‚¢ãƒ—ãƒªã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ãŸæ™‚ã«Apple IDã¨ã®é€£æºã‚‚è§£é™¤ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã§ã™ã€‚
iOSã§ã¯ã€è¨­å®šç”»é¢ã‹ã‚‰ã©ã®ã‚¢ãƒ—ãƒªã¨Apple IDé€£æºã—ãŸã‹ã‚’ç¢ºèªã§ãã‚‹ç”»é¢ãŒã‚ã‚Šã€ã‚¢ãƒ—ãƒªã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ™‚ã«Refresh Tokenã‚’Revokeã™ã‚‹ã¨ä¸€è¦§ã‹ã‚‰æ¶ˆãˆã¾ã™ã€‚

|ä¸€è¦§|è©³ç´°|
|:-:|:-:|
|![](/images/d77b038c51d4f4/settings-sign-in-with-apple-list.png =250x)|![](/images/d77b038c51d4f4/settings-sign-in-with-apple-gogh.jpg =250x)|

ã¾ãŸã€Apple IDé€£æºè§£é™¤å¾Œã«åŒã˜ã‚¢ãƒ—ãƒªã§Apple IDé€£æºã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€åˆæœŸã®ã‚¹ãƒ†ãƒ¼ãƒˆã§ã‚ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…±æœ‰ã™ã‚‹ã‹ã®ç”»é¢ã«ãªã‚Šã¾ã™ã€‚

![](/images/d77b038c51d4f4/gogh-first-sign-in-with-apple.png =250x)

Appleã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¯æš—å·åŒ–ã™ã‚‹ãªã‚Šã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚
ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ãŸApple IDé€£æºã®è§£é™¤ã¯[ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã®ä¿®æ­£ç‚¹](#ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã®ä¿®æ­£ç‚¹)ã§è¡Œã„ã¾ã™ã€‚

å…¨ã¦çµ‚ã‚ã£ãŸã‚‰ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã©ã®æƒ…å ±ã‚’è¿”ã™ã“ã¨ã§Appleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…ã¯å®Œäº†ã§ã™ã€‚

## ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã®ä¿®æ­£ç‚¹

Cognitoã‚„ã‚¢ãƒ—ãƒªå´ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±å‰Šé™¤ã‚‚ãã†ã§ã™ãŒã€Apple IDé€£æºãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€£æºè§£é™¤ã‚‚è¡Œã„ã¾ã™ã€‚
Apple IDé€£æºè§£é™¤ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¦ã‚ã‚‹ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦ã€ä¸‹è¨˜ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¾ã™ã€‚

https://developer.apple.com/documentation/sign_in_with_apple/revoke_tokens

```go:apple.go
// AppleãŒç™ºè¡Œã—ãŸãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹
// ç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ—ãƒªã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–¢é€£ä»˜ã‘ã‚’è§£é™¤ã™ã‚‹
func (a *AppleClient) RevokeRefreshToken(ctx context.Context, refreshToken string) error {
	return a.revokeTokens(ctx, refreshToken, RevokeTokenTypeHintRefreshToken)
}

// https://developer.apple.com/documentation/sign_in_with_apple/revoke_tokens
type revokeTokensReq struct {
	ClientId      string              `form:"client_id"`
	ClientSecret  string              `form:"client_secret"`
	Token         string              `form:"token"`
	TokenTypeHint revokeTokenTypeHint `form:"token_type_hint"`
}

type revokeTokenTypeHint string

const (
	RevokeTokenTypeHintRefreshToken revokeTokenTypeHint = "refresh_token"
	RevokeTokenTypeHintAccessToken  revokeTokenTypeHint = "access_token"
)

// Invalidate the tokens and associated user authorizations for a user when they are no longer associated with your app.
// https://developer.apple.com/documentation/sign_in_with_apple/revoke_tokens
func (a *AppleClient) revokeTokens(ctx context.Context, token string, tokenTypeHint revokeTokenTypeHint) error {
	clientSecret, err := a.clientSecretBuilder.getClientSecret(time.Now())
	if err != nil {
		return err
	}

	_, _, err = a.doRequest(ctx,
		http.MethodPost,
		revokeTokensPath,
		&revokeTokensReq{
			ClientId:      appleBundleId,
			ClientSecret:  clientSecret,
			Token:         token,
			TokenTypeHint: tokenTypeHint,
		},
	)
	return err
}
```

## Server-to-Server Notifications

åŸºæœ¬çš„ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¢ãƒ—ãƒªå†…ã‹ã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ãŒã€ã‚¢ãƒ—ãƒªå¤–ã‹ã‚‰Apple IDé€£æºã‚’è§£é™¤ã—ãŸã¨ãã‚„Appleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ãŸæ™‚ã«ã‚‚ã‚¢ãƒ—ãƒªã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚‚å‰Šé™¤ã•ã›ãŸã„ã§ã™ã€‚
ãã®ã‚ˆã†ãªå ´åˆã«Server-to-Server NotificationsãŒä½¿ãˆã¾ã™ã€‚

https://developer.apple.com/documentation/sign_in_with_apple/processing_changes_for_sign_in_with_apple_accounts

Server-to-Server Notificationsã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªå¤–ã§è¡Œã£ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã€AppleãŒæŒ‡å®šã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸HTTP POSTã§é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

ä»Šå›ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAppleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã€ã¾ãŸã¯ã‚¢ãƒ—ãƒªå¤–ã§Apple IDé€£æºã‚’è§£é™¤ã—ãŸã¨ãã‚’ä¾‹ã«ã—ã¾ã™ã€‚

### Request body

Appleã‹ã‚‰ã¯ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ãã‚‹ã®ã§ã€

```txt
HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
    "payload": "<SERVER_TO_SERVER_NOTIFICATION_JWT>"
}
```

ä¸‹è¨˜ã®æ§‹é€ ä½“ã§å—ã‘å–ã‚Šã¾ã™ã€‚

```go
type AppleNotificationRequest struct {
	Payload string `json:"payload"`
}
```

### Payloadã‚’Parse

Payloadã¯JWTãªã®ã§ã€å…¬é–‹éµã§æ¤œè¨¼ã€Parseã—ã¦æ§‹é€ ä½“ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚

`ParseStsNotificationPayload`ãŒ`AppleNotificationEvents`ã‚’è¿”å´ã™ã‚‹ã®ã§ã€`AppleNotificationEvents.Type`ãŒ`consent-revoked`ã¾ãŸã¯`account-delete`ã®ã¨ãã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã„ã„ã§ã—ã‚‡ã†ã€‚
`AppleNotificationEvents.Type`ã®ç¨®é¡ã¯[Decode and validate the notifications](https://developer.apple.com/documentation/sign_in_with_apple/processing_changes_for_sign_in_with_apple_accounts#4066122)ã«ã‚ã‚‹é€šã‚Šã€4ã¤ã‚ã‚Šã¾ã™ã€‚
ä»Šå›å–ã‚Šæ‰±ã†`consent-revoked`ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªå¤–ã§Apple IDé€£æºã‚’è§£é™¤ã—ãŸã¨ãã§ã€`account-delete`ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAppleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ãŸã¨ãã§ã™ã€‚

:::details Code

```go:apple.go
package apple

import (
	"context"
	"encoding/json"
	"fmt"
	"strings"
	"time"

	"github.com/lestrrat-go/jwx/v2/jws"
)

// Appleã®Server-to-Serveré€šçŸ¥ã§é€ã‚‰ã‚Œã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
// https://developer.apple.com/documentation/sign_in_with_apple/processing_changes_for_sign_in_with_apple_accounts#3683157
type AppleStsNotificationPayload struct {
	Iss    string `json:"iss"`
	Aud    string `json:"aud"`
	Exp    int64  `json:"exp"`
	Iat    int64  `json:"iat"`
	Jti    string `json:"jti"`
	Events string `json:"events"`
}

type AppleNotificationEvents struct {
	Type           AppleNotificationEventType `json:"type"`
	Sub            string                     `json:"sub"`
	Email          string                     `json:"email"`
	IsPrivateEmail string                     `json:"is_private_email"`
	EventTime      int64                      `json:"event_time"`
}

// https://developer.apple.com/documentation/sign_in_with_apple/processing_changes_for_sign_in_with_apple_accounts#4066122
type AppleNotificationEventType string

const (
	// The user revokes consent for your app to use their Apple ID and their credentials become invalid.
	AppleNotificationEventTypeConsentRevoked AppleNotificationEventType = "consent-revoked"
	// The user requests that Apple permanently delete their Apple ID.
	AppleNotificationEventTypeAccountDelete AppleNotificationEventType = "account-delete"
)

// Appleã®Sever-to-Serveré€šçŸ¥ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ã—ã€ãƒ‘ãƒ¼ã‚¹ã—ãŸJWTã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’è¿”å´ã™ã‚‹
func (a *AppleClient) ParseStsNotificationPayload(ctx context.Context, payload string, force bool) (*AppleNotificationEvents, error) {
	key, err := a.getPublicKey(ctx, force)
	if err != nil {
		return nil, err
	}

	// å…¬é–‹éµã‚’ä½¿ç”¨ã—ã¦ç½²åã‚’æ¤œè¨¼ã™ã‚‹
	rawJWT, err := jws.Verify([]byte(payload), jws.WithKeySet(key))
	if err != nil {
		// ç½²åã«å¤±æ•—ã—ã€å…¬é–‹éµãŒæœ‰åŠ¹æœŸé™åˆ‡ã‚Œã®å ´åˆã€å…¬é–‹éµã‚’å†å–å¾—ã—ã¦å†åº¦æ¤œè¨¼ã‚’è¡Œã†
		// forceãŒtrueã®å ´åˆã¯ãƒ«ãƒ¼ãƒ—ã‚’é˜²ããŸã‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
		if strings.Contains(err.Error(), "failed to find key") && !force {
			return a.ParseStsNotificationPayload(ctx, payload, true)
		}
		return nil, err
	}

	var appleStsNotificationPayload AppleStsNotificationPayload
	if err := json.Unmarshal(rawJWT, &appleStsNotificationPayload); err != nil {
		return nil, err
	}

	iss := appleStsNotificationPayload.Iss
	if iss != appleEndpointOrigin {
		return nil, fmt.Errorf("invalid issuer: expected %s, got %s", appleEndpointOrigin, iss)
	}

	aud := appleStsNotificationPayload.Aud
	if aud != appleBundleId {
		return nil, fmt.Errorf("invalid audience: expected %s, got %s", appleBundleId, aud)
	}

	iat := appleStsNotificationPayload.Iat
	now := time.Now()
	if time.Unix(iat, 0).After(now) {
		return nil, fmt.Errorf("invalid iat: expected before %s, got %s", now, time.Unix(iat, 0))
	}

	exp := appleStsNotificationPayload.Exp
	if time.Unix(exp, 0).Before(now) {
		return nil, fmt.Errorf("invalid exp: expected after %s, got %s", now, time.Unix(exp, 0))
	}

	var events AppleNotificationEvents
	if err := json.Unmarshal([]byte(appleStsNotificationPayload.Events), &events); err != nil {
		return nil, err
	}

	return &events, nil
}
```

:::

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç”¨æ„ã—ãŸã‚‰ã€Apple Developerã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ç™»éŒ²ã—ã¾ã—ã‚‡ã†ã€‚

# ãŠã‚ã‚Šã«

Sign in with Appleã®å°å…¥ã«ã‚ˆã‚Šã€Touch ID/Face IDã«ã‚ˆã‚‹ç›´æ„Ÿçš„ã§ã‚¹ãƒ ãƒ¼ã‚ºãªèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã§ãã¾ã—ãŸã€‚
ã¾ãŸã€ã“ã®è¨˜äº‹ã§ç´¹ä»‹ã—ãŸå®Ÿè£…ã¯ç¾åœ¨[gogh](https://gogh.gg)ã§å®Ÿéš›ã«æä¾›ã—ã¦ã„ã¾ã™ã€‚
æœ€è¿‘ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ã¯æ–°ãŸã«ã‚¹ãƒšãƒ¼ã‚¹æ©Ÿèƒ½ã‚‚å°å…¥ã•ã‚Œã€ã‚ˆã‚Šå¿«é©ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æä¾›ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ç”Ÿä½“èªè¨¼ã«ã‚ˆã‚‹ã‚¹ãƒ ãƒ¼ã‚ºãªãƒ­ã‚°ã‚¤ãƒ³ã¨åˆã‚ã›ã¦ã€ãœã²ã”åˆ©ç”¨ãã ã•ã„ã€‚

https://gogh.gg
